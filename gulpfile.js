/* jshint node:true */
"use strict";

var gulp = require("gulp");
var $ = require("gulp-load-plugins")();

gulp.task("styles", function() {
  return (
    gulp
      .src("app/styles/main.scss")
      .pipe($.plumber())
      .pipe(
        $.sass({
          style: "expanded",
          precision: 10
        })
      )
      .pipe(gulp.dest(".tmp/styles"))
  );
});

gulp.task("jshint", function() {
  return gulp
    .src("app/scripts/**/*.js")
    .pipe($.jshint())
    .pipe($.jshint.reporter("jshint-stylish"))
    .pipe($.jshint.reporter("fail"));
});

gulp.task("html", gulp.series("styles", function() {
  return gulp
    .src("app/*.html")
    .pipe($.if("*.js", $.uglify()))
    .pipe($.if("*.css", $.csso()))
    .pipe($.useref({ searchPath: "{.tmp,app}" }))
    .pipe($.if("*.html", $.minifyHtml({ conditionals: true, loose: true })))
    .pipe(gulp.dest("dist"));
}));

gulp.task("images", function() {
  return gulp.src("app/images/**/*").pipe(gulp.dest("dist/images"));
});

gulp.task("fonts", function() {
  return gulp
    .src("app/fonts/**/*")
    .pipe($.filter("**/*.{eot,svg,ttf,woff}"))
    .pipe($.flatten())
    .pipe(gulp.dest("dist/fonts"));
});

gulp.task("extras", function() {
  return gulp
    .src(
      [
        "app/*.*",
        "!app/*.html",
        "node_modules/apache-server-configs/dist/.htaccess"
      ],
      {
        dot: true
      }
    )
    .pipe(gulp.dest("dist"));
});

gulp.task("clean", require("del").bind(null, [".tmp", "dist"]));

gulp.task("connect", gulp.series("styles", function() {
  var serveStatic = require("serve-static");
  var serveIndex = require("serve-index");
  var app = require("connect")()
    .use(require("connect-livereload")({ port: 35729 }))
    .use(serveStatic(".tmp"))
    .use(serveStatic("app"))
    .use(serveIndex("app"));

  require("http")
    .createServer(app)
    .listen(9000)
    .on("listening", function() {
      console.log("Started connect web server on http://localhost:9000");
    });
}));

gulp.task("watch", gulp.series("connect", function() {
  $.livereload.listen();

  // watch for changes
  gulp
    .watch([
      "app/*.html",
      ".tmp/styles/**/*.css",
      "app/scripts/**/*.js",
      "app/images/**/*"
    ])
    .on("change", $.livereload.changed);

  gulp.watch("app/styles/**/*.scss", ["styles"]);
}));

gulp.task("serve", gulp.series("connect", "watch", function() {
  require("opn")("http://localhost:9000");
}));

gulp.task("build", gulp.series("jshint", "html", "images", "fonts", "extras", function() {
  return gulp.src("dist/**/*").pipe($.size({ title: "build", gzip: true }));
}));

gulp.task("default", gulp.series("clean", function() {
  gulp.start("build");
}));
